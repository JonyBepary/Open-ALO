name: CI - Tests and Checks

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        pip install flake8 black isort

    - name: Check code formatting (black)
      run: |
        black --check src/
      continue-on-error: true

    - name: Check import sorting (isort)
      run: |
        isort --check-only src/
      continue-on-error: true

    - name: Lint with flake8
      run: |
        flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics
      continue-on-error: true

  test-matrix:
    name: Test Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-gi \
          python3-gi-cairo \
          gir1.2-glib-2.0 \
          gir1.2-gst-plugins-base-1.0 \
          gstreamer1.0-pipewire \
          libcairo2-dev \
          libgirepository1.0-dev \
          pkg-config

    - name: Install package (using system Python)
      run: |
        python3 -m pip install --no-deps -e .

    - name: Run tests
      run: |
        cd tests
        python3 test_structure.py

    - name: Test import
      run: |
        python3 -c "from open_alo_core import UnifiedRemoteDesktop, WindowManager; print('âœ… OK')"

  build-check:
    name: Build Package Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install build tools
      run: |
        pip install build twine

    - name: Build package
      run: |
        python -m build

    - name: Check package
      run: |
        python -m twine check dist/*

    - name: List package contents
      run: |
        tar -tzf dist/*.tar.gz | head -30
